
format2hd - Windows 用フロッピーディスク簡易フォーマットツール


免責
----
本プログラムは無償で利用可能ですが、完全に無保証です。
利用者の責任においてご利用ください。


目的
----
Windows上でいわゆる３モードFDDのディスク初期化（フォーマット）を行う。
Windows 10 Anniversary Updateでformatコマンドから2HD形式（1.23 MB,
1024bytes/sector, 77 cylinders）のフォーマット機能が削除されたので、必要に
迫られて作成。
（2HD以外のフォーマットもできるが、それらは標準のformatコマンドで可能なので
そちらを使ったほうが「安全」だと思う）


動作要件
--------
・x86(32bit)/x64(64bit)のWindows
  （おそらくNT4以上で動作可能。95/98/Meでは動作しない）
・Windowsがサポートしているフロッピーディスクドライブ（2DD/2HD/1.44M）


用法
----
Windowsのコマンドプロンプトから実行します。

format2hd ドライブ: [/F:サイズ] [/VERIFY] [/I:イメージファイル名]
format2hd ドライブ: /LIST

    ドライブ:   フロッピーディスクドライブのドライブ文字（A:～Z:）

    /F:サイズ   初期化するディスクの容量
                /F:1.44     1.44MB（一般的なフロッピー容量。デフォルト）
                /F:1.23     1.23MB（いわゆる2HD。PC-98などで使われた）
                /F:1.2      1.2MB （2HC等と呼ばれる。PC/AT 5インチ高密度標準）
                /F:720      720KB （一般的な2DDフロッピーの容量）
                /F:640      640KB （PC-98などで使われた2DD容量。Windowsでは
                                   非標準扱いであることに注意）
                /F:DMF      1.68M （一部WindowsやOfficeのFD版で使われた形式。
                                   USB接続のFDDではほぼ初期化できない）

                /F:fake640  物理フォーマットを720KBで行い、640KB用の
                            ファイル構造でFATを初期化する。
                            /F:640 を指定できないドライブ上で無理やり640KBの
                            フォーマットを行うことができる。
                /F:fake640test
                            /F:fake640 とほぼ同じだが、実際にそのドライブが
                            640KBで初期化されたメディアを読み書きできるか
                            どうかのテストデータをメディア内に書き込む。
                            初期化の終わったディスクをいったんFDDから抜き
                            （意外と大事）、もう一度入れ直してから
                            ルートディレクトリ内の CHECK640.TXT を開いたとき、
                            "OK, 640K"と書かれていればひとまず成功。
                            それ以外のデータがある場合、そのFDDは残念ながら
                            640KBの2DDを正しく読み書きできない。

    /VERIFY     フォーマット時にディスクの読み出しチェックを行う。
                標準のformatコマンドとは異なり、読み取りエラーが発生した
                場合、不良クラスタ処理などは行わず、その場でフォーマット
                は失敗する。

    /I:イメージファイル名
                フォーマット後のディスクにイメージファイルの内容を書き込む。
                イメージファイルは720K、1.2M、1.23M、1.44Mのフロッピー用の
                いわゆるベタイメージファイル。正確にディスク容量と一致して
                いなくても書き込めるところまで書き込むが、ファイル長が
                セクタサイズで割り切れない場合の動作は不定となる点に注意。
                （512バイトのファイルを指定することで、1.44Mや720Kディスクの
                ブートセクタのみに書き込みを行うことができる。2HDの場合は
                1024バイト必要）
                ※640Kバイトディスク用のイメージファイルは正常に書き込む
                ことができません

    /LIST       ディスクドライブの対応フォーマットの一覧を表示する。
                対応リストは動的に変化し、メディア未挿入時、2HD挿入時、
                2DD挿入時ですべて異なる結果を返すことがある。また、一覧に
                表示されないフォーマットも実際は動作することがある。
                （あくまで「最低限対応している」程度の目安とお考え下さい）


注意・覚書
----------
・エラーチェックなどは最低限しか行っておりません（そのぶん処理が早くなって
  いる場合もあります）。
・FDドライブとWindows側のデバイスドライバが対応していない容量のフォーマットは
  当然できません（手持ちの3モードUSBFDDの中には、/F:640の640KB2DDフォーマットが
  できるものとできないものが両方ありました。2DDメディアを挿入した状態で /LIST
  オプションを実行したとき、一覧の中に640Kがあれば少なくとも640Kフォーマット
  対応が確定していると思われます）。
・/F:640 のオプションを受け付けないFDDでも /F:fake640 を指定することで
  640KB 2DD相当に初期化されたディスクを作ることができます。ただし、出来上がった
  ディスクメディアをそのドライブが正しく読み書きできる保証はまったく
  ありません。/F:fake640test オプションで作成したディスクの内容を
  確認することである程度チェック可能です。USB接続のFDDの中には正しく扱えない
  ものがあるので事前に確認したほうがよいでしょう。
  レガシー接続（いわゆる「標準フロッピーディスクコントローラ―」）の場合は
  ほぼ問題ないと思われます。
  640KB 2DDに対応していないFDDに640KBフォーマットされたFDを挿入すると、
  最悪の場合、書かれたデータが破壊され回復不能になります。じゅうぶん
  ご注意ください。
・/F:DMFはほぼレガシー接続FDD専用です。ただし、初期化はできても書き込みを行う
  ことができない場合があります。
  USB接続FDDの場合、手持ちのドライブの中でこのオプションが使えるものは
  ひとつもありませんでしたが、DMF形式で初期化したメディアの読み書きができる
  ものは存在しているようです。
・トラックフォーマット直後のFAT情報やディスクイメージ書き込み時、
  Media ChangedやWrong Diskなどのエラーが出るドライブが存在します。そのまま
  コマンドを再実行するとうまくいくことが多いようです（今後対策したい）。


ソース
------
https://github.com/lpproj/mydosuty/tree/master/win/format2hd
